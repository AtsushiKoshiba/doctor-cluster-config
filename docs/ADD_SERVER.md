# Setting up new hosts

Here we assume `$hostname` to be the hostname (such as yasmin) and `$host` a resolvable (as in `ssh root@$host`).

To open a shell with required tools installed (such as sops) you can use the nix package manager `nix develop`.


## First Steps

First, establish a direct connection (1 to 1, ideally no switch) with the server and set up your machine as a gateway. 
On NixOS you can use the module described here [dnsmasq.nix](DNSMASQ.md).

On Ubuntu you have to set up a network bridge (here named *internal*) using `systemd-networkd` and `brctl`.
More specifically, create the following files ([source](https://major.io/2015/03/26/creating-a-bridge-for-virtual-machines-using-systemd-networkd/)):
```
❯ cat /etc/systemd/network/internal.netdev
[NetDev]
Name=internal
Kind=bridge

❯ cat /etc/systemd/network/uplink.network
[Match]
Name=eth0
[Network]
Bridge=internal

❯ cat /etc/systemd/network/internal.network
[Match]
Name=internal
[Network]
Address=192.168.32.50/24
LLMNR=true
LLDP=true
```
Start systemd-neworkd with `systemctl start systemd-networkd`.
Check the created bridge with `brctl show`.
After you make sure your bridge is set up successfully `sudo ip l set eth0 master internal`.
Install `dnsmasq` and append the extra config from `dnsmasq.nix` into `/etc/dnsmasq.conf`:
```
interface=internal
#interface=virttap
listen-address=127.0.0.1
dhcp-range=192.168.32.50,192.168.32.100,12h
# disable dns
port=0
```
and then restart the dnsmasq service with `sudo systemctl restart dnsmasq.service`.
`journalctl -f -u dnsmasq` will give you the IP address of the server.

Clone the `doctor-cluster-config` repo and run:
`nix --extra-experimental-features nix-command --extra-experimental-features flakes develop`

If it's your first setup, to generate new admin key, run (requires [age](https://github.com/FiloSottile/age)):
```
mkdir -p ~/.config/sops/age/
age-keygen -o ~/.config/sops/age/keys.txt
```
Provide the generated key to a pre-existing admin and wait for it to be deployed.
Pull the new repo version with your added key and then by running `sops secrets.yaml` you will get the decrypted secrets where you can find the IPMI password to set.

Go to the IPMI administration page in your browser and set the decrypted IPMI login credentials found with `sops secrets.yml`.

## PXEBoot


Offer an image via pixie network boot and boot the server from it:

```
nix shell .#netboot-pixie-core --command "sudo netboot-pixie-core"
```

Given that your ssh key is in `module/users.nix`, you may connect now via `ssh root@$host` to check out `lsblk` or fix internet connectivity. 
Take care that your ssh-agent is working for later inv commands to work. 


## IPMI / UEFI

In this step you try to find sane IPMI and UEFI settings.

Make sure the system is booted into EFI:

```
[root@nixos:~]# mount | grep efivars
efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime)
```

Also make sure to enable IPMI serial over lan (run `nix-shell -p ipmitool` on the same machine):

```console
ipmitool sol set privilege-level admin
ipmitool sol set force-encryption false
ipmitool sol set enabled true
ipmitool sol payload enable
```

Some motherboards might use a different channel instead of the default `0`, append some other number
i.e. `1` to each command than

```
ipmitool sol set privilege-level admin 1
ipmitool sol set force-encryption false 1
ipmitool sol set enabled true 1
ipmitool sol payload enable 1
```

Also make sure IPMI over lan is enabled in the BMC website and Serial over lan
redirection is enabled in the BIOS/firmware setup page (vendor-specific).

## SSH CA

Create ssh ca certificate, so that hosts automatically trust each other.
``` console
$ cd modules/sshd
$ HOST=astrid
$ IP=IP_OR_HOSTNAME_FOR_SCANNING
$ ./ssh-ca-sign $HOST,$HOST.r,$HOST.dse.in.tum.de,$HOST.thalheim.io $IP
$ mv $IP-cert.pub ./modules/sshd/certs/$HOST-cert.pub
```

## Prepare NixOS config

Prepare a config for a new host:

Generate a sops key for `$hostname` (from the ssh identity of the pxebooted OS)

```
inv print-age-key $host
```

in `sops.yaml.nix`, add the printed key to `keys` and add `sops_permissions` for `hosts/$hostname.yml`:

```nix
keys = {
  $hostname = "ageKEYGIBBERISH";
  ...
};
sops_permissions = with keys; {
  "hosts/$hostname.yml$" = [ $hostname ];
  ...
};
```

Changes in sops.yaml.nix have to be applied with

```
nix2yaml sops.yaml.nix > .sops.yaml
```

With that creation rule we can create and populate `hosts/$hostname.yml` secrets with a random root password generated by this command:

```
inv generate-root-password
echo 'tePO3QGAhAil' | mkpasswd -m sha-512 -s
$6$PPHuMAbzR8hdWmoz$yNKoHqY0GGoXm65AzS4h/VuJVJkORMc68WFk/e3cZ5foJsfxw9LeFBP5s/L5muRZF4/RVn3xYVYPbBGEYo3Xq0
# Add the following secrets
root-password: tePO3QGAhAil
root-password-hash: $6$PPHuMAbzR8hdWmoz$yNKoHqY0GGoXm65AzS4h/VuJVJkORMc68WFk/e3cZ5foJsfxw9LeFBP5s/L5muRZF4/RVn3xYVYPbBGEYo3Xq0
```

Use sops than to add the generated secrets above to the host:

```
sops hosts/$hostname.yml
```

Note that if a rule wasn't created but only changed, run `sops updatekeys path/to.yml` to re-encrypt it.

Generate a `hardware-configuration.nix` on the server with `nixos-generate-config --dir .` and copy it into `modules/hardware/$hardwarename.nix`.

Write a sane, simple configuration to `hosts/$hostname.nix`:

```nix
{
  pkgs,
  lib,
  ...
}: {
  imports = [
    ../modules/hardware/$hardwarename.nix
  ];

  networking.hostName = "$hostname";

  system.stateVersion = "checkwhatversiontheotherfilesuse";
}
```

Add `hosts/$hostname.nix` in `configurations.nix`.

Push config to github master branch (becuase the server will pull the commit from there during installation).

## Install NixOS

Format the disk

```
# if machine has nvme 
  inv format-disks --hosts $host  --disk /dev/nvme0n1
# if machine has ssd
  inv format-disks --hosts $host  --disk /dev/sda
```

Install nixOS

```
inv install-nixos --hosts $host  --flakeattr $hostname
```

Finally, note down the MAC addresses of the relevant NICs (and the IPMI) which are printed by install-nixos to give them to the chair admins. 
